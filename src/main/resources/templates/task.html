<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<head>
<title th:text="${@environment.getProperty('application_name')}"></title>
</head>
<body>
	<div th:replace="base::css-core"></div>
	<div id="wrapper">
		<div th:replace="layout-dashboard :: navbar"></div>
		<div id="page-wrapper">
			<div class="row">
				<div class="col-lg-12">
					<div th:replace="layout-dashboard :: switch-user"></div>
					<h1 th:text="${#messages.msg('label.job_instances.title')}"
						class="page-header">Jobs</h1>
				</div>
				<div class="col-lg-12">

					<div id="content">
						<section>
							<h1 th:text="${#messages.msg('label.task.title')}">Task
								Details</h1>
							<div th:if="${alertSuccess}" class="alert alert-success fade in">
								<a href="#" class="close" data-dismiss="alert">&times;</a><span
									th:text="${alertSuccess}">Success message.</span>
							</div>
							<div th:if="${alertWarning}" class="alert alert-warning fade in">
								<a href="#" class="close" data-dismiss="alert">&times;</a><span
									th:text="${alertWarning}">Warning message.</span>
							</div>
							<form class="form" action="/task" method="POST">
								<div th:if="${result!=null AND result.hasErrors()}"
									class="alert alert-warning fade in">
									<ul>
										<li th:each="err : ${result.allErrors}"
											th:text="${err.defaultMessage}">Input is incorrect</li>
									</ul>
								</div>
								<input type="hidden" th:name="${_csrf.parameterName}"
									th:value="${_csrf.token}" /> <input type="hidden"
									th:name="taskId" th:value="${task.id}" /> <input type="hidden"
									th:name="form_document" th:value="${form_document}" /><input
									type="hidden" th:name="action" th:value="'update'" />
								<table class="table">
									<thead>
										<tr>
											<th th:text="${#messages.msg('label.key')}">Key</th>
											<th th:text="${#messages.msg('label.value')}">Value</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td th:text="${#messages.msg('label.tasks.businessKey')}">Business
												Key</td>
											<td th:text="${businessKey}">task_key</td>
										</tr>
										<tr>
											<td th:text="${#messages.msg('label.tasks.name')}">Name</td>
											<td th:text="${task.name}">task_name</td>
										</tr>
										<tr>
											<td th:text="${#messages.msg('label.tasks.created')}">Created</td>
											<td><span th:if="${@xchange3Util.showRelativeTime}"
												class="timeago"
												th:title="${@documentController.getIso8601DateFormat(task.createTime)}"
												th:text="${task.createTime}"></span><span
												th:if="${!@xchange3Util.showRelativeTime}"
												th:text="${#calendars.format(task.createTime,'dd MMM yyyy HH:mm')}"></span></td>
										</tr>
										<tr>
											<td th:text="${#messages.msg('label.task.processDocuments')}">Process
												Documents</td>
											<td id="process_documents">
												<table th:fragment="process_documents"
													class="table table-compact"
													th:if="${process_documents!=null}">
													<thead>
														<tr>
															<th th:text="${#messages.msg('label.task.reference')}">Reference</th>
															<th th:text="${#messages.msg('label.task.status')}">Status</th>
															<th th:text="${#messages.msg('label.task.type')}">Type</th>
															<th th:text="${#messages.msg('label.task.received')}">Received</th>
														</tr>
													</thead>
													<tbody>
														<tr th:each="document : ${process_documents}">
															<td><a href="document.html"
																th:href="@{'/document/'+${document.uuid}}"
																th:text="${document.reference}">reference</a></td>
															<td th:include="base :: document_status"></td>
															<td th:text="${#messages.msg({document.type}+'_short')}">type</td>
															<td><span th:if="${@xchange3Util.showRelativeTime}"
																class="timeago"
																th:title="${@documentController.getIso8601DateFormat(document.dateReceived)}"
																th:text="${document.dateReceived}"></span><span
																th:if="${!@xchange3Util.showRelativeTime}"
																th:text="${#calendars.format(document.dateReceived,'dd MMM yyyy HH:mm')}"></span></td>
														</tr>
													</tbody>
												</table>
											</td>
										</tr>
										<tr
											sec:authorize="!hasRole('ROLE_SUPPLIER_INQUIRER') and !hasRole('ROLE_BUYER_INQUIRER') and !hasRole('ROLE_BANK_INQUIRER') and !hasRole('ROLE_FUNDER_INQUIRER') and !hasRole('ROLE_ADMIN')">
											<td th:text="${#messages.msg('label.tasks.action')}">Action</td>
											<td><a th:unless="${action}=='edit' or ${task_actions}"
												class="btn btn-xs btn-primary"
												th:href="${completeRedirect != null} ? @{/task/__${task.id}__/complete(redirect=${completeRedirect})} : @{/task/__${task.id}__/complete}"
												href="#"
												th:onClick="${verifyAuthenticatorCode!=null and verifyAuthenticatorCode['complete']?'vac(href); return false;':'return true;'}"><span
													class="glyphicon glyphicon-check"></span> <span
													th:text="${#messages.msg('label.button.complete')}">Complete</span></a>
												<span th:each="task_action : ${task_actions}"
												th:switch="${task_action.key}"> <a th:case="'accept'"
													th:unless="${action}=='edit'"
													class="btn btn-xs btn-success"
													th:onClick="${verifyAuthenticatorCode!=null and verifyAuthenticatorCode['accept']?'vac(href); return false;':'return true;'}"
													th:href="${acceptRedirect != null} ? @{/task/__${task.id}__/__${task_action.key}__(redirect=${acceptRedirect})} : @{/task/__${task.id}__/__${task_action.key}__}"
													href="#"><span class="glyphicon glyphicon-ok-sign"></span>
														<span th:text="${task_action.value}">Accept</span></a><a
													th:case="'reject'" th:unless="${action}=='edit'"
													class="btn btn-xs btn-danger"
													th:onClick="${verifyAuthenticatorCode!=null and verifyAuthenticatorCode['reject']?'vac(href); return false;':'return true;'}"
													th:href="${rejectRedirect != null} ? @{/task/__${task.id}__/__${task_action.key}__(redirect=${rejectRedirect})} : @{/task/__${task.id}__/__${task_action.key}__}"
													href="#"><span class="glyphicon glyphicon-remove-sign"></span>
														<span th:text="${task_action.value}">Reject</span></a> <a
													th:case="'cancel'" th:unless="${action}=='edit'"
													class="btn btn-xs btn-danger"
													th:onClick="${verifyAuthenticatorCode!=null and verifyAuthenticatorCode['cancel']?'vac(href); return false;':'return true;'}"
													th:href="@{/task/__${task.id}__/__${task_action.key}__}"
													href="#"><span class="glyphicon glyphicon-check"></span>
														<span th:text="${task_action.value}">Cancel</span></a> <a
													th:case="'settle'" th:unless="${action}=='edit'"
													th:onClick="${verifyAuthenticatorCode!=null and verifyAuthenticatorCode['settle']?'vac(href); return false;':'return true;'}"
													class="btn btn-xs btn-success"
													th:href="${settleRedirect != null} ? @{/task/__${task.id}__/__${task_action.key}__(redirect=${settleRedirect})} : @{/task/__${task.id}__/__${task_action.key}__}"
													href="#"><span class="glyphicon glyphicon-ok-sign"></span>
														<span th:text="${task_action.value}">Settle</span></a> <a
													th:case="'revise'" th:unless="${action}=='edit'"
													th:onClick="${verifyAuthenticatorCode!=null and verifyAuthenticatorCode['revise']?'vac(href); return false;':'return true;'}"
													class="btn btn-xs btn-danger"
													th:href="${reviseRedirect != null} ? @{/task/__${task.id}__/__${task_action.key}__(redirect=${reviseRedirect})} : @{/task/__${task.id}__/__${task_action.key}__}"
													href="#"><span class="glyphicon glyphicon-remove-sign"></span>
														<span th:text="${task_action.value}">Revise</span></a> <a
													th:case="'request'" th:unless="${action}=='edit'"
													th:onClick="${verifyAuthenticatorCode!=null and verifyAuthenticatorCode['request']?'vac(href); return false;':'return true;'}"
													class="btn btn-xs btn-primary"
													th:href="${requestRedirect != null} ? @{/task/__${task.id}__/__${task_action.key}__(redirect=${requestRedirect})} : @{/task/__${task.id}__/__${task_action.key}__}"
													href="#"><span class="glyphicon glyphicon-remove-sign"></span>
														<span th:text="${task_action.value}">Request</span></a> <a
													th:case="'delete'" th:unless="${action}=='edit'"
													th:onClick="${verifyAuthenticatorCode!=null and verifyAuthenticatorCode['delete']?'vac(href); return false;':'return true;'}"
													class="btn btn-xs btn-danger"
													th:href="${requestRedirect != null} ? @{/task/__${task.id}__/__${task_action.key}__(redirect=${requestRedirect})} : @{/task/__${task.id}__/__${task_action.key}__}"
													href="#"><span class="glyphicon glyphicon-remove-sign"></span>
														<span th:text="${task_action.value}">Delete</span></a><a
													th:case="*" th:unless="${action}=='edit'"
													class="btn btn-xs btn-primary"
													th:href="@{/task/__${task.id}__/__${task_action.key}__}"
													th:onClick="${verifyAuthenticatorCode!=null and verifyAuthenticatorCode['complete']?'vac(href); return false;':'return true;'}"
													href="#"><span class="glyphicon glyphicon-check"></span>
														<span th:text="${task_action.value}">Complete</span></a>
											</span> <a th:unless="${action}=='edit'" th:if="${form_editable}"
												class="btn btn-xs btn-warning"
												th:href="@{/task/__${task.id}__/edit}" href="#"><span
													class="glyphicon glyphicon-edit"></span> <span
													th:text="${#messages.msg('label.button.edit')}">Edit</span></a>
												<button type="submit" th:if="${action}=='edit'"
													class="btn btn-xs btn-success">
													<span class="glyphicon glyphicon-floppy-save"></span> <span
														th:text="${#messages.msg('label.button.save')}">Save</span>
												</button>
												<button type="reset" th:if="${action}=='edit'"
													class="btn btn-xs btn-danger">
													<span class="glyphicon glyphicon-floppy-remove"></span> <span
														th:text="${#messages.msg('label.button.clear')}">Clear</span>
												</button>

												<div id="acPopover" class="popover right">
													<div class="arrow"></div>
													<div class="popover-content">
														<h4>Authorization Code required</h4>
														<div id="acPopoverMsgSuccess"
															class="alert alert-success fade in"
															style="display: none;"></div>
														<div id="acPopoverMsgWarning"
															class="alert alert-warning fade in"
															style="display: none;"></div>
														<p>To complete this action, enter authorization code
															below</p>
														<div class="input-group input-group-sm">
															<input name="authenticatorCode" type="password"
																class="form-control" placeholder="Code..." /> <span
																class="input-group-btn"> <a id="acPopoverSubmit"
																href="#" type="button"
																class="form-control btn btn-primary"
																th:text="${#messages.msg('label.secondfactor.submit')}">Submit
															</a>
															</span> <a id="acPopoverSms" href="#"
																class="form-control btn btn-warning"
																th:text="${#messages.msg('label.secondfactor.send_sms')}">Send
																SMS</a>
														</div>
													</div>
												</div></td>
										</tr>
									</tbody>
								</table>

								<div class="panel panel-default">
									<div class="panel-body">
										<h2 th:text="${#messages.msg({form_key}+'_long')}">Document
											Content</h2>
										<div
											th:include="@{http://xchange3(uuid=${form_document},form_key=${form_key},action=${action},lang=${#ctx.locale})}">
											<span th:text="${#messages.msg('label.task.notAvaliable')}">Not
												available</span>
										</div>
									</div>
								</div>
							</form>
						</section>
					</div>



				</div>
			</div>
		</div>

		<!-- /#page-wrapper -->
	</div>
	<!-- /#wrapper -->
	<div th:replace="base::js-core"></div>
	<script type="text/javascript">
		/*<![CDATA[*/

		function vac(href) {
			$("#acPopover").fadeIn(500);
			$("#acPopoverSubmit").attr('href', href);
			$("#acPopover input").focus();
			$("#acPopoverSubmit").click(function(data) {
				return vacClick();
			})
			$('#acPopover input').on('keypress', function(event) {
				if (event.which === 13) {
					return vacClick();
				}
			});
		}

		function vacClick() {
			var href = $("#acPopoverSubmit").attr('href')
			href += ((href.indexOf('?') == -1) ? '?' : '&');
			href += $.param($("#acPopover input"));
			window.location.href = href;
			return false;
		}

		$("#acPopoverSms").click(function() {
			$.ajax({
				url : "/secondfactor/sms"
			}).error(function(error) {
				var json = jQuery.parseJSON(error.responseText);
				$("#acPopoverMsgWarning").html(json.message);
				$("#acPopoverMsgWarning").show();
			}).done(function(data) {
				$("#acPopoverSms").attr("disabled", true);
				$("#acPopoverMsgSuccess").html(data);
				$("#acPopoverMsgSuccess").show();
			});
		});

		jQuery(document)
				.ready(
						function() {
							var url = /*[[@{/task(id=${task.id},view=process_documents)}]]*/null;
							jQuery("span.timeago").timeago();
							(window.formDocumentReady || function() {
							})();
							setTimeout(function() {
								$.get(url, function(data) {
									$("#process_documents").html(data);
									jQuery("span.timeago").timeago();
								});
							}, 3000);
							setTimeout(function() {
								$(".alert").alert('close');
							}, 8000);

						});
		$("ul#menu-list li#tasks-list").addClass("active");
		/*]]>*/
	</script>
</body>
</html>